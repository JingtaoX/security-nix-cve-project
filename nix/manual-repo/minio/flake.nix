# TODO: A nixos module to replicate:
# https://www.exploit-db.com/exploits/51734
{

  #TODO: need to fix this to the version of minio that I need..
  #  Version: Up to (excluding) 2022-07-29T19-40-48Z - need this version
  # Try: 2022-05-08T23-50-31Z - 
  inputs.nixpkgs.url =
    "github:NixOS/nixpkgs/34bfa9403e42eece93d1a3740e9d8a02fceafbca";
  outputs = { self, nixpkgs, ... }:
    let
      system = "x86_64-linux";
      pkgs = import nixpkgs { inherit system; };

      python = pkgs.python3.withPackages (p: with p; [ requests minio ]);

      # python writer without checks!
      pythonWriter = pkgs.writers.makeScriptWriter {
        interpreter = "${python}/bin/python3";
      };
      exploit = pythonWriter "/bin/exploit" (builtins.readFile ./exploit.py);
      # writePythonScript = interp: name: text:
      #   pkgs.writeScript name ''
      #     #!/bin/sh
      #     exec ${interp}/bin/python ${pkgs.writeScript "inner-${name}" text}
      #   '';
      #
      # exploit =
      #   writePythonScript python "exploit" (builtins.readFile ./exploit.py);
    in {
      packages."${system}".exploit = exploit;
      nixosModules.module = { pkgs, ... }: {
        # systemState = "23.05";
        system.stateVersion = "23.05";
        boot.isContainer = true;
        # enable to verify version
        environment.systemPackages = [ pkgs.minio exploit ];
        services.minio = {
          enable = true;
          # consoleAddress = ":9001";
          accessKey = "minioadmin";
          secretKey = "minioadmin";

        };

      };

      nixosConfigurations.minio = nixpkgs.lib.nixosSystem {
        system = "x86_64-linux";
        modules = [ self.nixosModules.module ];
      };
    };

}
